pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY_ID = credentials('ACESS_KEY')
        AWS_SECRET_ACCESS_KEY = credentials('SECRET_KEY')
        AWS_REGION = 'us-east-1'
        CLUSTER_NAME = 'k8s'
        FRONTEND_DOCKER_IMAGE_NAME = 'frontend'
        BACKEND_DOCKER_IMAGE_NAME = 'backend'
        IMAGE_TAG = 'latest'
        DOCKERHUBUSER = 'shubhamsk512'
    }
        stages{
        stage('Validate AWS CLI Credentials') {
            steps {
                script {
                    // Verify AWS CLI configuration by checking identity
                    sh """
                    aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
                    aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
                    aws configure set region ${AWS_REGION}

                    # Validate the credentials by calling STS to get the caller identity
                    aws sts get-caller-identity
                    """
                }
            }
        }
        stage('Checkout SCM') {
            steps {
                script {
                    checkout(scmGit(
                        branches: [[name: '*/main']],
                        extensions: [],
                        userRemoteConfigs: [[url: 'https://github.com/Imsk31/angular-springboot.git']]
                    ))
                }
            }
        }    
        stage('Logging into DockerHub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId:"dockerhubcred", passwordVariable:"dockerhubpass", usernameVariable:"dockerhubuser")]){
                    sh "docker login -u ${env.dockerhubuser} -p ${env.dockerhubpass}"
                    dir('angular-java/spring-backend') {
                    sh "docker build -t ${env.dockerhubuser}/${BACKEND_DOCKER_IMAGE_NAME}:${IMAGE_TAG} ."
                    sh "docker push ${env.dockerhubuser}/${BACKEND_DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
                        }
                    }    
                }    
            }
        }
        stage('Updating Kubeconfig') {
            steps {
                script {
                    // Updating Cluster Name and Region To Kubeconfig
                    sh "aws eks --region ${AWS_REGION} update-kubeconfig --name ${CLUSTER_NAME}"
                }
            }
        }
        stage('Create Namespace') {
            steps {
                script {
                    // Check if the 'dev' namespace exists
                    def namespace_exists = sh(script: "kubectl get ns dev --ignore-not-found", returnStdout: true).trim()

                    if (namespace_exists) {
                        echo "Namespace 'dev' already exists."
                    } else {
                        // Create the 'dev' namespace if it doesn't exist
                        sh "kubectl create ns dev"
                        echo "Namespace 'dev' created successfully."
                    }
                }
            }
        }
        stage('Replacing Backend Image URI in Deployment Manifest File') {
            steps {
                script {
                    def imageName = "${env.DOCKERHUBUSER}/${BACKEND_DOCKER_IMAGE_NAME}:${IMAGE_TAG}"
                    def manifestFile = 'angular-java/spring-backend/manifest/deployment.yaml'

                    // Use sed to replace the image in the YAML file
                    sh """
                    sed -i 's|image:.*|image: ${imageName}|' ${manifestFile}
                    """
                    
                    // verify the replacement
                    sh "cat ${manifestFile}"
                }
            }
        }
        stage('Creating Deployment And service for backend') {
            steps {
                dir('angular-java/spring-backend/manifest') {
                    script {
                        sh 'kubectl apply -f deployment.yaml -n dev'
                        sh 'kubectl apply -f service.yaml -n dev'
                    }
                }
            }
        }
        stage('Frontend Kubernetes Service Deployment') {
            steps {
                dir('angular-java/angular-frontend/manifest') {
                    sh 'kubectl apply -f service.yaml -n dev'
                }
            }
        }
        stage('Apply Kubernetes Ingress') {
            steps {
                script {
                    sh '''
                    # Apply the Ingress configuration for the application
                    kubectl apply -f ingress.yaml -n dev
                    '''
                }
            }
        }
        stage('Replacing Frontend Image URI in Manifest File') {
            steps {
                script {
                    def imageURI = "${FRONTEND_REPO}:${IMAGE_TAG}"
                    def manifestFile = 'angular-java/angular-frontend/manifest/deployment.yaml'

                    sh """
                    sed -i 's|image:.*|image: ${imageURI}|' ${manifestFile}
                    """
                    sh "cat ${manifestFile}"
                }
            }
        }
        stage('Frontend Kubernetes Deployment') {
            steps {
                dir('angular-java/angular-frontend/manifest') {
                    sh 'kubectl apply -f deployment.yaml -n dev'
                }
            }
        }
         stage("Delete unneccesary images and containers") {
            steps {
                script {
                    sh ''' 
                    docker stop $(docker ps -q) && docker rm $(docker ps -aq) && docker system prune -af --volumes 
                    echo "Deleted all unccessary images and conainers and cleared workspace "
                    '''
                }
            }
        }
        stage('Clear Workspace') {
            steps {
                cleanWs()
                }
            }    
        }
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        failure {
            echo 'Pipeline failed.'
        }
        success {
            echo 'Pipeline succeeded.'
        }
}
}
